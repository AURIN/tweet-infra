
<VirtualHost *:80>

  # CouchDB cluster
  <Proxy balancer://couchdbcluster>
    <% for(var i=0; i < db.names.length; i++) { %>
       BalancerMember http://<%= db.names[i] %>:${COUCHDB_PORT}/ ping=500ms
    <% } %>
    ProxySet lbmethod=byrequests failonstatus=503,404
  </Proxy>

  # Admin user for the master node
  <Location />
    AuthType Basic
    AuthName "Authentication Required"
    AuthUserFile ${APACHE_DIR}/conf/htpasswd
    <RequireAll>
      Require method GET POST PUT DELETE HEAD OPTIONS
      Require user admin
    </RequireAll>
    ProxyPass http://tweet-1-db:${COUCHDB_PORT}/
    ProxyPassReverse http://tweet-1-db:${COUCHDB_PORT}/
  </Location>

  # Read-only user (auth is stripped, to avoid adding users to CouchDB)
  <Location /couchdbro>
    AuthType Basic
    AuthName "Authentication Required"
    AuthUserFile ${APACHE_DIR}/conf/htpasswd
    <RequireAll>
      Require user readonly
      Require method GET HEAD OPTIONS
    </RequireAll>
    RequestHeader unset Authorization
    ProxyPass balancer://couchdbcluster
    ProxyPassReverse balancer://couchdbcluster
  </Location>
  
  # Harvester user (auth is stripped, to avoid adding users to CouchDB) 
  <Location /couchdbh>
    AuthType Basic
    AuthName "Authentication Required"
    AuthUserFile ${APACHE_DIR}/conf/htpasswd
    <RequireAll>
      Require user harvester 
      Require method GET POST PUT DELETE HEAD OPTIONS
    </RequireAll>
    RequestHeader unset Authorization
    ProxyPass balancer://couchdbcluster
    ProxyPassReverse balancer://couchdbcluster
  </Location>

  ProxyRequests Off

</VirtualHost>
